from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from decimal import Decimal

from app.database.models import ServiceCategory, ServiceSubcategory, PaymentMethod
from app.services.voice_service import VoiceService


def get_main_menu_keyboard() -> InlineKeyboardMarkup:
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ¯ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ€Ğ²Ğ¸Ñ", callback_data="service_start")],
        [InlineKeyboardButton(text="ğŸ’° ĞœĞ¾Ğ¹ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ", callback_data="balance_info")],
        [InlineKeyboardButton(text="ğŸ’³ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ", callback_data="payment_start")],
        [InlineKeyboardButton(text="ğŸ“Š Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²", callback_data="history")],
        [InlineKeyboardButton(text="â„¹ï¸ ĞŸĞ¾Ğ¼Ğ¾Ñ‰ÑŒ", callback_data="help")]
    ])


def get_service_categories_keyboard() -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹ ÑƒÑĞ»ÑƒĞ³."""
    voice_service = VoiceService(None)  # Ğ”Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğ¹
    
    buttons = []
    for category in ServiceCategory:
        description = voice_service.get_category_description(category)
        buttons.append([InlineKeyboardButton(
            text=description,
            callback_data=f"category_{category.value}"
        )])
    
    buttons.append([InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_main")])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_service_subcategories_keyboard(category: ServiceCategory) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¿Ğ¾Ğ´ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ğ¹."""
    voice_service = VoiceService(None)
    subcategories = voice_service.get_subcategories_by_category(category)
    
    buttons = []
    for subcategory in subcategories:
        description = voice_service.get_subcategory_description(subcategory)
        buttons.append([InlineKeyboardButton(
            text=description,
            callback_data=f"subcategory_{subcategory.value}"
        )])
    
    buttons.append([InlineKeyboardButton(text="ğŸ”™ Ğš ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼", callback_data="back_to_categories")])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_payment_amounts_keyboard() -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑÑƒĞ¼Ğ¼ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ."""
    amounts = [100, 300, 500, 1000, 2000]
    
    buttons = []
    for amount in amounts:
        buttons.append([InlineKeyboardButton(
            text=f"{amount} â‚½",
            callback_data=f"payment_amount_{amount}"
        )])
    
    buttons.append([InlineKeyboardButton(text="ğŸ’° Ğ”Ñ€ÑƒĞ³Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ°", callback_data="payment_custom_amount")])
    buttons.append([InlineKeyboardButton(text="ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´", callback_data="back_to_main")])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_payment_methods_keyboard(amount: Decimal) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ² Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ñ‹."""
    buttons = [
        [InlineKeyboardButton(
            text="ğŸ’³ YooMoney",
            callback_data=f"payment_method_{PaymentMethod.YOOMONEY.value}_{amount}"
        )],
        [InlineKeyboardButton(
            text="â­ Telegram Stars", 
            callback_data=f"payment_method_{PaymentMethod.TELEGRAM_STARS.value}_{amount}"
        )],
        [InlineKeyboardButton(text="ğŸ”™ Ğš Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ ÑÑƒĞ¼Ğ¼Ñ‹", callback_data="back_to_amounts")]
    ]
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_balance_keyboard(user_balance: Decimal) -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ¼."""
    buttons = [
        [InlineKeyboardButton(text="ğŸ’³ ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ", callback_data="payment_start")],
        [InlineKeyboardButton(text="ğŸ“Š Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹", callback_data="payment_history")]
    ]
    
    if user_balance > 0:
        buttons.insert(0, [InlineKeyboardButton(
            text="ğŸ¯ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑĞµÑ€Ğ²Ğ¸Ñ",
            callback_data="service_start"
        )])
    
    buttons.append([InlineKeyboardButton(text="ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_main")])
    
    return InlineKeyboardMarkup(inline_keyboard=buttons)


def get_service_confirmation_keyboard() -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ÑĞµÑ€Ğ²Ğ¸ÑĞ°."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ", callback_data="service_confirm")],
        [InlineKeyboardButton(text="ğŸ”™ Ğš Ğ¿Ğ¾Ğ´ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼", callback_data="back_to_subcategories")],
        [InlineKeyboardButton(text="ğŸ  Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_main")]
    ])


def get_back_to_categories_keyboard() -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ° Ğº ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”™ Ğš ĞºĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸ÑĞ¼", callback_data="service_start")]
    ])


def get_history_keyboard() -> InlineKeyboardMarkup:
    """ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ´Ğ»Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²."""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ", callback_data="history_refresh")],
        [InlineKeyboardButton(text="ğŸ”™ Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ", callback_data="back_to_main")]
    ])